<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modal Scale Trainer</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300&display=swap" rel="stylesheet">
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            margin: 0;
            transition: background 0.5s ease;
            box-sizing: border-box;
            overflow: hidden;
        }
        #center-wrapper {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex: 1;
            width: 100%;
        }
        #main-display {
            font-size: min(15vw, 128px);
            margin-bottom: 80px;
            font-family: 'Fredoka One', sans-serif;
            text-align: center;
            overflow-wrap: break-word;
            word-break: break-word;
        }
        #controls {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 80px;
            width: 80%;
            max-width: 800px;
        }
        #left-hand, #right-hand {
            font-size: min(8vw, 32px);
            font-family: 'Fredoka One', sans-serif;
            width: min(20vw, 200px);
            text-align: center;
        }
        button {
            font-size: min(6vw, 24px);
            padding: 10px 20px;
            cursor: pointer;
            margin: 0 20px;
        }
        #piano {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            height: 160px;
            max-width: 1120px;
            width: 95%;
        }
        .key {
            box-sizing: border-box;
            position: absolute;
            border: 1px solid #000;
        }
        .key.white {
            background: #fff;
        }
        .key.black {
            background: #000;
            z-index: 1;
        }
        .finger {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Fredoka One', sans-serif;
        }

        #parameters {
            position: absolute;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.5);
            box-sizing: border-box;
            padding: 5px;
            font-family: 'Fredoka One', sans-serif;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
        }
        .header-title {
            width: 100%;
            text-align: center;
            font-size: min(5vw, 24px);
            margin-bottom: 10px;
            font-style: italic;
        }
        .params-sections {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: space-around;
            align-items: flex-start;
            width: 100%;
        }
        #modes-section, #keys-section, #about-section {
            margin: 10px 20px 0;
        }
        #modes-section .title, #keys-section .title, #about-section .title {
            font-size: min(4vw, 14px);
            text-align: left;
        }
        .modes-list, .keys-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start;
        }
        .mode-item, .key-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: min(3vw, 12px);
        }
        .mode-item {
            margin: 0 15px 15px 0;
        }
        .key-item {
            margin: 0 5px 5px 0;
        }
        .mode-item label, .key-item label {
            margin-bottom: 2px;
            line-height: 1;
            white-space: nowrap;
        }
        .mode-item input, .key-item input {
            display: none;
            margin: 0;
        }
        .mode-item label::after, .key-item label::after {
            content: '';
            display: block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 1px solid rgba(0, 0, 0, 0.5);
            background-color: var(--item-color);
            text-align: center;
            line-height: 12px;
            font-size: 8px;
            color: var(--symbol-color);
            margin-top: 2px;
            margin-left: auto;
            margin-right: auto;
        }
        .mode-item input:checked + label::after, .key-item input:checked + label::after {
            content: '✔';
        }
        .description {
            text-align: left;
            font-size: min(3vw, 12px);
            line-height: 1.2;
            font-family: 'Fredoka', sans-serif;
            font-weight: 300;
        }

        @media (max-width: 768px) {
            #main-display {
                font-size: min(15vw, 64px);
            }
            button {
                font-size: min(6vw, 18px);
                padding: 5px 10px;
                margin: 0 10px;
            }
            #left-hand, #right-hand {
                font-size: min(8vw, 28px);
            }
            #piano {
                height: auto;
            }
            .params-sections {
                justify-content: flex-start;
            }
        }

        @media (max-width: 480px) {
            #main-display {
                font-size: min(15vw, 48px);
            }
        }
    </style>
</head>
<body>
    <div id="parameters">
        <div class="header-title">Modal Piano Scale Trainer</div>
        <div class="params-sections">
            <div id="about-section">
                <div class="title">About</div>
                <div class="description">This tool tests your memory by drilling piano scale fingerings, for randomized keys and modes. Fingerings are adapted from typical textbook 2-octave fingerings, but focused on the octave-crossing portion to enable unlimited bidirectional octave extension during improvisation.</div>
            </div>
            <div id="keys-section">
                <div class="title">Keys</div>
                <div class="keys-list"></div>
            </div>
            <div id="modes-section">
                <div class="title">Modes</div>
                <div class="modes-list"></div>
            </div>
        </div>
    </div>
    <div id="center-wrapper">
        <div id="main-display"></div>
        <div id="controls">
            <div id="left-hand"></div>
            <button onclick="selectRandomKey()">Next Key</button>
            <div id="right-hand"></div>
        </div>
    </div>
    <script>
        const keys = ['C', 'G', 'D', 'A', 'E', 'B', 'G♭', 'D♭', 'A♭', 'E♭', 'B♭', 'F'];
        const modesOrder = ['Lydian', 'Ionian', 'Mixolydian', 'Dorian', 'Aeolian', 'Phrygian', 'Locrian'];
        const hands = ['Left', 'Right'];
        const keyColors = {
            'C': '#FF0000',   // red
            'G': '#FF7F00',   // orange
            'D': '#FFFF00',   // yellow
            'A': '#7FFF00',   // lime
            'E': '#00FF00',   // green
            'B': '#00FF7F',   // spring green
            'G♭': '#00FFFF',  // cyan
            'D♭': '#007FFF',  // azure
            'A♭': '#0000FF',  // blue
            'E♭': '#7F00FF',  // violet
            'B♭': '#FF00FF',  // magenta
            'F': '#FF007F'    // rose
        };

        const modeColors = {
            'Lydian': '#FFD700',      // gold, bright and dreamy
            'Ionian': '#FFFF00',      // yellow, happy
            'Mixolydian': '#FFA500',  // orange, energetic
            'Dorian': '#98FB98',      // pale green, minor but hopeful
            'Aeolian': '#4169E1',     // royal blue, sad
            'Phrygian': '#FF4500',    // orange red, tense
            'Locrian': '#483D8B'      // dark slate blue, unstable
        };

        const flatToSharp = {
            'G♭': 'F#',
            'D♭': 'C#',
            'A♭': 'G#',
            'E♭': 'D#',
            'B♭': 'A#'
        };

        const sharpToFlat = {
            'C#': 'D♭',
            'D#': 'E♭',
            'F#': 'G♭',
            'G#': 'A♭',
            'A#': 'B♭'
        };

        const octaveNotes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

        const modeDegrees = {
            'Ionian': 1,
            'Dorian': 2,
            'Phrygian': 3,
            'Lydian': 4,
            'Mixolydian': 5,
            'Aeolian': 6,
            'Locrian': 7
        };

        const semitonesToDegree = {
            1: 0,
            2: 2,
            3: 4,
            4: 5,
            5: 7,
            6: 9,
            7: 11
        };

        const modeIntervals = {
            'Ionian': [2, 2, 1, 2, 2, 2, 1],
            'Dorian': [2, 1, 2, 2, 2, 1, 2],
            'Phrygian': [1, 2, 2, 2, 1, 2, 2],
            'Lydian': [2, 2, 2, 1, 2, 2, 1],
            'Mixolydian': [2, 2, 1, 2, 2, 1, 2],
            'Aeolian': [2, 1, 2, 2, 1, 2, 2],
            'Locrian': [1, 2, 2, 1, 2, 2, 2]
        };

        const leftFingerings = {
            'C': '14321321',
            'D♭': '32143213',
            'D': '14321321',
            'E♭': '32143213',
            'E': '14321321',
            'F': '14321321',
            'G♭': '43213214',
            'G': '14321321',
            'A♭': '32143213',
            'A': '14321321',
            'B♭': '32143213',
            'B': '13214321'
        };

        const rightFingerings = {
            'C': '12312341',
            'D♭': '23123412',
            'D': '12312341',
            'E♭': '31234123',
            'E': '12312341',
            'F': '12341231',
            'G♭': '23412312',
            'G': '12312341',
            'A♭': '34123123',
            'A': '12312341',
            'B♭': '41231234',
            'B': '12312341'
        };

        let currentKey, currentMode, currentHand;
        let allNotes;
        let currentNumOctaves = null;

        function getContrastColor(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            return luminance > 0.5 ? '#000000' : '#FFFFFF';
        }

        function getRelativeKey(tonic, semitones_down) {
            let note = flatToSharp[tonic] || tonic;
            let idx = octaveNotes.indexOf(note);
            let newIdx = (idx - semitones_down + 120) % 12;
            let newNote = octaveNotes[newIdx];
            return sharpToFlat[newNote] || newNote;
        }

        function getScaleNotes(tonic, mode) {
            let note = flatToSharp[tonic] || tonic;
            let current = octaveNotes.indexOf(note);
            let scale = [octaveNotes[current % 12]];
            const intervals = modeIntervals[mode];
            for (let i = 0; i < 7; i++) {
                current = (current + intervals[i]) % 12;
                scale.push(octaveNotes[current]);
            }
            return scale.map(n => sharpToFlat[n] || n);
        }

        function createKeyboard() {
            const numOctaves = window.innerWidth < 768 ? 2 : 3;
            currentNumOctaves = numOctaves;
            allNotes = [];
            for (let o = 0; o < numOctaves; o++) {
                allNotes = allNotes.concat(octaveNotes);
            }
            const piano = document.createElement('div');
            piano.id = 'piano';
            for (let i = 0; i < allNotes.length; i++) {
                const note = allNotes[i];
                const isBlack = note.includes('#');
                const keyElem = document.createElement('div');
                keyElem.className = `key ${isBlack ? 'black' : 'white'}`;
                keyElem.dataset.note = note;
                piano.appendChild(keyElem);
            }
            document.body.appendChild(piano);
        }

        function resizeKeyboard() {
            const numOctaves = window.innerWidth < 768 ? 2 : 3;
            if (numOctaves !== currentNumOctaves) {
                const oldPiano = document.getElementById('piano');
                if (oldPiano) oldPiano.remove();
                createKeyboard();
            }
            const piano = document.getElementById('piano');
            const maxWhiteKeys = numOctaves * 7;
            const defaultWhiteWidth = 40;
            const containerWidth = window.innerWidth;
            const maxPianoWidth = maxWhiteKeys * defaultWhiteWidth;
            const targetPianoWidth = Math.min(containerWidth * 0.95, maxPianoWidth);
            piano.style.width = `${targetPianoWidth}px`;
            const whiteWidth = targetPianoWidth / maxWhiteKeys;
            const blackWidth = whiteWidth * 0.6;
            const whiteHeight = whiteWidth * 4;
            const blackHeight = whiteWidth * 2.4;
            const offset = blackWidth / 2;
            document.documentElement.style.setProperty('--key-scale', whiteWidth / defaultWhiteWidth);

            let currentLeft = 0;
            const keysElems = piano.querySelectorAll('.key');
            keysElems.forEach(key => {
                const isBlack = key.classList.contains('black');
                if (!isBlack) {
                    key.style.left = `${currentLeft}px`;
                    key.style.width = `${whiteWidth}px`;
                    key.style.height = `${whiteHeight}px`;
                    currentLeft += whiteWidth;
                } else {
                    key.style.left = `${currentLeft - offset}px`;
                    key.style.width = `${blackWidth}px`;
                    key.style.height = `${blackHeight}px`;
                }
            });
            piano.style.height = `${whiteHeight}px`;
            document.body.style.paddingBottom = `${whiteHeight}px`;

            const parameters = document.getElementById('parameters');
            parameters.style.width = `${targetPianoWidth}px`;

            const centerWrapper = document.getElementById('center-wrapper');
            centerWrapper.style.paddingTop = `${parameters.offsetHeight}px`;
        }

        function drawFingers(key, mode, hand) {
            // Remove existing fingers
            const existingFingers = document.querySelectorAll('.finger');
            existingFingers.forEach(e => e.remove());

            // Compute fingering
            const degree = modeDegrees[mode];
            const semitones_down = semitonesToDegree[degree];
            const relativeKey = getRelativeKey(key, semitones_down);
            let fingeringStr = hand === 'Left' ? leftFingerings[relativeKey] : rightFingerings[relativeKey];
            const base = fingeringStr.substring(0, 7);
            const offset = degree - 1;
            const rotated = base.substring(offset) + base.substring(0, offset);
            const fingering = rotated + rotated.charAt(0);
            const fingers = fingering.split('');

            // Get scale notes
            const tonic_note = flatToSharp[key] || key;
            const scaleNotes = getScaleNotes(key, mode);

            // Ionian tonic
            const ionian_tonic = flatToSharp[relativeKey] || relativeKey;

            // Determine starting index
            const tonic_idx = octaveNotes.indexOf(tonic_note);
            const octaveOffset = hand === 'Left' ? 0 : 12;
            let startIndex = tonic_idx + octaveOffset;
            if (startIndex + 12 >= allNotes.length) {
                startIndex -= octaveOffset;
            }

            // Compute positions
            const positions = [];
            let currentPos = startIndex;
            positions.push(currentPos);
            const intervals = modeIntervals[mode];
            for (let i = 0; i < 7; i++) {
                currentPos += intervals[i];
                positions.push(currentPos);
            }

            // Add finger numbers
            const keyElems = document.querySelectorAll('.key');
            for (let i = 0; i < 8; i++) {
                const pos = positions[i];
                if (pos >= allNotes.length) continue;
                const keyElem = keyElems[pos];
                const span = document.createElement('span');
                span.className = 'finger';
                const finger = fingers[i];
                span.innerText = finger;
                span.style.bottom = `calc(5px * var(--key-scale))`;
                span.style.fontSize = `calc(16px * var(--key-scale))`;
                span.style.color = keyElem.classList.contains('black') ? 'white' : 'black';
                if (scaleNotes[i] === ionian_tonic) {
                    span.style.border = '1px solid currentColor';
                    span.style.padding = '0px 2px';
                    span.style.borderRadius = '2px';
                }
                keyElem.appendChild(span);
            }
        }

        function populateModes() {
            const modesList = document.querySelector('.modes-list');
            modesOrder.forEach(mode => {
                const item = document.createElement('div');
                item.className = 'mode-item';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `mode-${mode}`;
                checkbox.checked = true;
                const label = document.createElement('label');
                label.htmlFor = `mode-${mode}`;
                label.innerText = mode.substring(0, 3);
                item.appendChild(checkbox);
                item.appendChild(label);
                item.style.setProperty('--item-color', modeColors[mode]);
                item.style.setProperty('--symbol-color', getContrastColor(modeColors[mode]));
                modesList.appendChild(item);
            });
        }

        function populateKeys() {
            const keysList = document.querySelector('.keys-list');
            keys.forEach(key => {
                const item = document.createElement('div');
                item.className = 'key-item';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                const keyId = key.replace('♭', 'b');
                checkbox.id = `key-${keyId}`;
                checkbox.checked = true;
                const label = document.createElement('label');
                label.htmlFor = `key-${keyId}`;
                label.innerText = key;
                item.appendChild(checkbox);
                item.appendChild(label);
                item.style.setProperty('--item-color', keyColors[key]);
                item.style.setProperty('--symbol-color', getContrastColor(keyColors[key]));
                keysList.appendChild(item);
            });
        }

        function selectRandomKey() {
            let allowedModes = modesOrder.filter(m => document.getElementById(`mode-${m}`).checked);
            allowedModes = allowedModes.length > 0 ? allowedModes : modesOrder;

            let allowedKeys = keys.filter(k => document.getElementById(`key-${k.replace('♭', 'b')}`).checked);
            allowedKeys = allowedKeys.length > 0 ? allowedKeys : keys;

            const mode = allowedModes[Math.floor(Math.random() * allowedModes.length)];
            const hand = hands[Math.floor(Math.random() * hands.length)];
            const key = allowedKeys[Math.floor(Math.random() * allowedKeys.length)];

            currentKey = key;
            currentMode = mode;
            currentHand = hand;

            document.getElementById('main-display').innerText = `${key} ${mode}`;
            if (hand === 'Left') {
                document.getElementById('left-hand').innerHTML = 'Left<br>Hand';
                document.getElementById('right-hand').innerHTML = '';
            } else {
                document.getElementById('left-hand').innerHTML = '';
                document.getElementById('right-hand').innerHTML = 'Right<br>Hand';
            }
            document.body.style.background = `linear-gradient(135deg, ${modeColors[mode]} 0%, ${keyColors[key]} 100%)`;

            // Draw fingers
            drawFingers(key, mode, hand);
        }

        // Initial setup
        window.onload = () => {
            createKeyboard();
            populateKeys();
            populateModes();
            resizeKeyboard();
            selectRandomKey();
        };

        window.addEventListener('resize', () => {
            resizeKeyboard();
            if (currentKey && currentMode && currentHand) {
                drawFingers(currentKey, currentMode, currentHand);
            }
        });
    </script>
</body>
</html>
